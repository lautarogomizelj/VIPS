@model VIPS.Web.Models.RouteViewModel

@{
    Layout = "_ConductorLayout";
	string lang = User.FindFirst("Lang")?.Value ?? "es";
}

@if (Model == null)
{

<div class="contenedorGestionRutas">

    <div class="contenedorResultadoRutas">
        <div class="result-container">
            <div class="status-icon error">
                📋
            </div>

            <h2 class="result-title error">
                @(lang == "es" ? "No hay rutas disponibles" : "No routes available")
            </h2>

            <p class="result-message">
                @(lang == "es" ? "Actualmente no hay rutas sin asignar en el sistema." : "There are currently no unassigned routes in the system.")
            </p>

            <div class="result-details error">
                <div class="detail-item">
                    <span class="detail-label">
                        @(lang == "es" ? "Estado:" : "Status:")
                    </span>
                    <span class="detail-value error">
                        @(lang == "es" ? "Sin rutas pendientes" : "No pending routes")
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">
                        @(lang == "es" ? "Acción recomendada:" : "Recommended action:")
                    </span>
                    <span class="detail-value">
                        @(lang == "es" ? "Generar nuevas rutas" : "Generate new routes")
                    </span>
                </div>
            </div>

            <div class="actions">
                <a asp-action="Index" asp-controller="Conductor" class="btn btn-secondary">
                    🏠 @(lang == "es" ? "Volver al Dashboard" : "Back to Dashboard")
                </a>
            </div>
        </div>
    </div>
</div>

}
else
{

    var url = "https://www.google.com/maps/dir/";
    var cantTotal = 0;
    var cantCompletados = 0;

    // Agrego el punto de partida primero
    if (ViewBag.PuntoPartidaActual != null)
    {
        url += Uri.EscapeDataString(ViewBag.PuntoPartidaActual) + "/";
    }

    // Luego agrego todos los pedidos
    foreach (var pedido in ViewBag.Pedidos)
    {
        url += Uri.EscapeDataString(pedido.Direccion) + "/";
        cantTotal = pedido.CantTotal;
        cantCompletados = pedido.CantCompletados;
    }


<div class="main-content">
    <div class="route-header">
        <div class="route-title">📱 @(lang == "es" ? "Mis Rutas" : "My Routes")</div>

        <div class="route-info">
            <div class="info-item">
                <span class="info-label">@(lang == "es" ? "Ruta" : "Route")</span>
                <span class="info-value">#@Model.IdRuta.ToString("D3") – @(lang == "es" ? "Camión" : "Truck") @Model.Patente</span>
            </div>
            <div class="info-item">
                <span class="info-label">@(lang == "es" ? "Fecha" : "Date")</span>
                <span class="info-value">@Model.FechaCreacion.ToString("dd/MM/yyyy")</span>
            </div>
            <div class="info-item">
                <span class="info-label">@(lang == "es" ? "Pedidos" : "Orders")</span>
                <span class="info-value">@Model.CantPedidos</span>
            </div>
            <div class="info-item">
                <span class="info-label">@(lang == "es" ? "Estado" : "Status")</span>
                <span class="route-status @(
                    Model.Estado== "Pendiente" ? "status-pending" :
                    Model.Estado== "En camino" ? "status-en-camino" :
                    Model.Estado== "Finalizada" ? "status-finalizada" :
                    Model.Estado== "Cancelada" ? "status-cancelada" :
                    Model.Estado== "Sin Asignar" ? "status-entregado" : "status-sin-asignar")">
                    @Model.Estado
                </span>
            </div>
        </div>

        <a href="@url" target="_blank" class="map-button">🗺️ @(lang == "es" ? "Ver mapa completo" : "View full map")</a>
        <a asp-action="ExportarRutaAGpxConductor" asp-controller="Conductor" asp-route-idRuta="Model.IdRuta" class="btn btn-primary">
            📡 Exportar a gpx
        </a>
    </div>

    <div class="orders-section">
        <div class="orders-title">@(lang == "es" ? "📦 Pedidos Asignados (Orden de Entrega)" : "📦 Order list (delivery order)")</div>

        @foreach (var pedido in ViewBag.Pedidos)
        {

        <div class="order-item">
            <div class="order-header" onclick="toggleDetails(@pedido.OrdenEntrega)">
                <div class="order-number">@pedido.OrdenEntrega</div>
                <div class="order-status">
                    <span class="route-status @(
    pedido.Estado == "Pendiente" ? "status-pending" :
    pedido.Estado == "Programado" ? "status-programado" :
    pedido.Estado == "Reprogramado" ? "status-reprogramado" :
    pedido.Estado == "En camino" ? "status-en-camino-pedido" :
    pedido.Estado == "Fallido" ? "status-fallido" :
    pedido.Estado == "Entregado" ? "status-entregado" :
    "status-pending")">
                        @pedido.Estado
                    </span>
                </div>

                <div class="order-info">
                    <div class="order-address">@pedido.Direccion</div>
                    <div class="order-client">@pedido.Cliente</div>
                </div>
                <div class="expand-icon" id="icon-@pedido.OrdenEntrega">▼</div>
            </div>

            <div class="order-details" id="details-@pedido.OrdenEntrega">
                <div class="detail-item">
                    <span class="detail-label">@(lang == "es" ? "Tel" : "Phone"):</span>
                    <span class="detail-value">@pedido.TelefonoCliente</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">@(lang == "es" ? "Observaciones" : "Notes"):</span>
                    <span class="detail-value"></span>
                </div>

                @if(Model.Estado == "En camino" && pedido.Estado != "Entregado" && pedido.Estado != "Fallido")
                    {
                <div class="action-buttons">
                    <a class="btn-entregado" asp-action="MarcarEntregaEntregada" asp-controller="Conductor" asp-route-idPedido="@pedido.IdPedido" asp-route-idRuta="@Model.IdRuta">✓ @(lang == "es" ? "Entregado" : "Delivered")</a>
                    <a class="btn-fallido" asp-action="MarcarEntregaFallida" asp-controller="Conductor" asp-route-idPedido="@pedido.IdPedido" asp-route-idRuta="@Model.IdRuta">✗  @(lang == "es" ? "Fallido" : "Failed")</a>
                </div>
                    }
            </div>
        </div>
        }


    </div>

    <div class="summary-footer">
        <div class="progress-info">
            @(lang == "es" ? "Pedidos completados" : "Completed orders"): <span class="progress-count">@cantCompletados/@cantTotal</span>
        </div>


        @if(Model.Estado == "Pendiente" && cantCompletados == 0)
        {
        <a class="finalize-button enabled" asp-action="IniciarRuta" asp-controller="Conductor" asp-route-idRuta="@Model.IdRuta">@(lang == "es" ? "Iniciar ruta" : "Start route")</a>
        }
        else if(Model.Estado == "En camino" && cantCompletados == cantTotal)
        //aca tiene que decir cantRealizados poruqe cantCompletados no incluye los fallidos, solo los entregados
        {

        <a class="finalize-button enabled" asp-action="FinalizarRuta" asp-controller="Conductor" asp-route-idRuta="@Model.IdRuta">@(lang == "es" ? "Finalizar ruta" : "Finish route")</a>
        }
        else
        {
        <a class="finalize-button">@(lang == "es" ? "Finalizar ruta" : "Finish route")</a>
        }
    </div>




</div>

}

<!-- CAJA DE ÉXITO -->
@if (!string.IsNullOrEmpty(TempData["SuccessMessageConductorRuta"]?.ToString()))
{
<div class="success-box">
    <div class="success-icon">✅</div>
    <div class="success-content">
        <div class="success-title">@(lang == "es" ? "Operación exitosa" : "Successful operation")</div>
        <div class="success-message">@TempData["SuccessMessageConductorRuta"]</div>
    </div>
</div>
}

<!-- CAJA DE ERROR -->
@if (!string.IsNullOrEmpty(TempData["ErrorMessageConductorRuta"]?.ToString()))
{
<div class="error-box">
    <div class="error-icon">⚠️</div>
    <div class="error-content">
        <div class="error-title">@(lang == "es" ? "Error" : "Error")</div>
        <div class="error-message">@TempData["ErrorMessageConductorRuta"]</div>
    </div>
</div>
}




@section Scripts {
    <script src="~/js/app.js"></script>
}
